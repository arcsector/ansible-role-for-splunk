---
# We have to do this first so that we store the captain before removing from the cluster
- name: Get SHCluster captain
  include_tasks: get_shcluster_captain.yml

- name: Remove SHCluster member
  ansible.builtin.command: "{{ splunk_home }}/bin/splunk -auth {{ splunk_auth }} remove shcluster-member"
  register: splunk_remove_shcluster_member
  changed_when: splunk_remove_shcluster_member.rc == 0
  failed_when: splunk_remove_shcluster_member.rc != 0
  no_log: true

- name: Clean KVStore
  include_tasks: adhoc_clean_kvstore.yml

- name: Add SHCluster member from current member
  ansible.builtin.command: |
    {{ splunk_home }}/bin/splunk -auth {{ splunk_auth }} add shcluster-member -current_member_uri {{ splunk_shc_captain }}
  register: splunk_remove_shcluster_member
  changed_when: splunk_remove_shcluster_member.rc == 0
  failed_when: splunk_remove_shcluster_member.rc != 0
  no_log: true
